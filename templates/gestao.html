
{% extends 'base.html' %}
{% block title %}Gestão — Tutorias (geral){% endblock %}
{% block content %}
<div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-2">
  <h2 class="h5 mb-0">Painel da Gestão — visão geral</h2>
  <div class="d-flex gap-2">
    <button class="btn btn-outline-primary btn-sm" onclick="carregar()">Atualizar</button>
    <form method="post" action="/gestao/bloquear" class="d-inline">
      <button class="btn btn-outline-danger btn-sm">Bloquear Gestão</button>
    </form>
  </div>
</div>

<div class="card mb-3">
  <div class="card-body">
    <h3 class="h6">Carimbo Digital</h3>
    <div class="row g-2">
      <div class="col-md-3"><input class="form-control" id="c_resp" placeholder="Responsável"></div>
      <div class="col-md-3"><input class="form-control" id="c_inst" placeholder="Instituição"></div>
      <div class="col-md-3"><input class="form-control" id="c_contato" placeholder="Contato (opcional)"></div>
      <div class="col-md-3"><input class="form-control" id="c_texto" value="ÊXITO VISTADO"></div>
      <div class="col-12"><input class="form-control" id="c_obs" placeholder="Observações (opcional)"></div>
      <div class="col-12 d-flex flex-wrap gap-2 mt-2">
        <button class="btn btn-success btn-sm" onclick="aplicarTodas()">Aplicar em todas</button>
        <button class="btn btn-outline-success btn-sm" onclick="aplicarSelecionadas()">Aplicar nas selecionadas</button>
      </div>
      <div id="msg" class="mt-2"></div>
    </div>
  </div>
</div>


<div class="card mb-3 border-danger">
  <div class="card-body">
    <h3 class="h6 text-danger mb-1">Manutenção / Limpeza de tutorias</h3>
    <div class="small text-muted mb-2">Use com cuidado: estes botões apagam registros do banco para liberar armazenamento.</div>
    <div class="d-flex flex-wrap gap-2">
      <button class="btn btn-outline-secondary btn-sm" onclick="selecionarTudo(true)">Selecionar todas</button>
      <button class="btn btn-outline-secondary btn-sm" onclick="selecionarTudo(false)">Desmarcar</button>
      <button class="btn btn-outline-danger btn-sm" onclick="apagarSelecionadas()">Apagar selecionadas</button>
      <button class="btn btn-danger btn-sm" onclick="apagarTodas()">Apagar TODAS</button>
    </div>
  </div>
</div>

<div id="board"></div>
{% endblock %}

{% block scripts %}
<script>
function toast(ok, txt){
  const el = document.getElementById('msg');
  el.innerHTML = `<div class="alert ${ok?'alert-success':'alert-danger'} py-2 mb-0">${txt}</div>`;
  setTimeout(()=>{ el.innerHTML=''; }, 2500);
}
function fmtData(iso){
  const d = new Date(iso);
  return d.toLocaleDateString('pt-BR', {weekday:'long', day:'2-digit', month:'2-digit', year:'numeric'});
}
function diaKey(iso){
  const d = new Date(iso);
  const y = d.getFullYear(), m = (d.getMonth()+1+'').padStart(2,'0'), dd=(''+d.getDate()).padStart(2,'0');
  return `${y}-${m}-${dd}`;
}
function campos(){
  return {
    resp: document.getElementById('c_resp').value.trim(),
    inst: document.getElementById('c_inst').value.trim(),
    contato: document.getElementById('c_contato').value.trim(),
    texto: document.getElementById('c_texto').value.trim() || 'ÊXITO VISTADO',
    obs: document.getElementById('c_obs').value.trim(),
  };
}
function chk(id){ return `<input class="form-check-input sel" type="checkbox" data-id="${id}">`; }

function selecionarTudo(on){
  document.querySelectorAll('.sel').forEach(c=>{ c.checked = !!on; });
}

function pedirSenhaExclusao(){
  const s = prompt('Digite a senha para APAGAR tutorias:');
  if(!s) return null;
  return s.trim();
}

async function carregar(){
  const nowQ = { params: { t: Date.now() } };
  const [profR, itemsR] = await Promise.all([axios.get('/api/gestao/professores', nowQ), axios.get('/api/gestao/tutorias', nowQ)]);
  const profs = {}; (profR.data||[]).forEach(p=>profs[p.id]=p.username);
  const items = itemsR.data || [];
  const byDay = {};
  items.forEach(t=>{
    const k = diaKey(t.criado_em);
    byDay[k] = byDay[k] || {};
    const prof = profs[t.professor_id] || ('#'+t.professor_id);
    byDay[k][prof] = byDay[k][prof] || [];
    byDay[k][prof].push(t);
  });
  const days = Object.keys(byDay).sort().reverse();
  const board = document.getElementById('board');
  board.innerHTML = days.map(day => {
    const groups = byDay[day];
    const diaLabel = fmtData(day+'T00:00:00Z');
    const profNames = Object.keys(groups).sort((a,b)=>a.localeCompare(b));
    const sections = profNames.map(name=>{
      const arr = groups[name].sort((a,b)=> new Date(b.criado_em) - new Date(a.criado_em));
      const cards = arr.map(t=>`
        <div class="col-12 col-md-6">
          <div class="card shadow-sm mb-2">
            <div class="card-body p-3">
              <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
                <div>
                  <div class="fw-bold">${t.nome_aluno} <span class="badge text-bg-primary">${t.serie}</span></div>
                  <div class="small text-muted">${new Date(t.criado_em).toLocaleString('pt-BR')}</div>
                  <div class="small text-secondary">Professor: <b>${name}</b></div>
                  <div class="small text-secondary">Tutor: <b>${t.nome_tutor || '—'}</b></div>
                </div>
                <div class="d-flex align-items-center gap-2">
                  ${chk(t.id)}
                  <button class="btn btn-sm btn-outline-primary" onclick="aplicarUm(${t.id})">Carimbar só esta</button>
                  <button class="btn btn-sm btn-outline-success" onclick="gerarPdfDoElemento('gst-print-${t.id}', 'tutoria-${t.id}.pdf')">PDF</button>
                <button class=\"btn btn-sm btn-outline-danger\" onclick=\"apagarUm(${t.id})\">Apagar</button>
</div>
              </div>
              <div class="printable p-3 mt-2" id="gst-print-${t.id}">
                <h3 class="h6 text-center mb-2">Tutoria Digital — Formulário</h3>
                <div class="row small">
                  <div class="col-6"><b>Tutor:</b> ${t.nome_tutor || '—'}</div>
                  <div class="col-6"><b>Aluno:</b> ${t.nome_aluno}</div>
                  <div class="col-3"><b>Série:</b> ${t.serie}</div>
                  <div class="col-3"><b>Data/Hora:</b> ${new Date(t.criado_em).toLocaleString('pt-BR')}</div>
                  <div class="col-6"><b>Telefone aluno:</b> ${t.tel_aluno || '—'}</div>
                  <div class="col-12 mt-2"><b>Projeto de Vida:</b><br>${t.projeto_vida || '-'}</div>
                  <div class="col-12 mt-2"><b>Descrições (problemas e orientações):</b><br>${t.descricoes || '-'}</div>
                  <div class="col-12 mt-2"><b>Ocorrências:</b> ${(t.ocorrencias||[]).join(', ') || '-'}</div>
                  <div class="col-12 mt-2"><b>Assinatura do aluno:</b><br>${t.assinatura ? `<img src="${t.assinatura}" style="max-width:280px;border:1px solid #000;">` : '-'}</div>
                  <div class="col-12 mt-3">
                    <div class="p-3 rounded-2" style="border:2px dashed #1976d2; background:#f4f8ff;">
                      <div class="fw-bold" style="color:#1976d2;">${(t.carimbo && t.carimbo.texto) || 'ÊXITO VISTADO'}</div>
                      <div class="small"><b>Responsável:</b> ${(t.carimbo && t.carimbo.resp) || '—'}</div>
                      <div class="small"><b>Instituição:</b> ${(t.carimbo && t.carimbo.inst) || '—'}</div>
                      <div class="small"><b>Contato:</b> ${(t.carimbo && t.carimbo.contato) || '—'}</div>
                      <div class="small"><b>Observações:</b> ${(t.carimbo && t.carimbo.obs) || '—'}</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      `).join('');
      return `
        <div class="card mb-3">
          <div class="card-header bg-white"><b>${name}</b></div>
          <div class="card-body">
            <div class="row">${cards}</div>
          </div>
        </div>
      `;
    }).join('');
    return `
      <div class="mb-4">
        <h3 class="h6 text-uppercase text-secondary mb-2">${diaLabel}</h3>
        ${sections || '<div class="alert alert-info">Sem registros.</div>'}
      </div>
    `;
  }).join('');
}

function selecionados(){
  return Array.from(document.querySelectorAll('.sel:checked')).map(x=>Number(x.getAttribute('data-id')));
}
async function aplicarTodas(){
  const c = campos();
  try{
    const r = await axios.post('/api/gestao/carimbo', c, {headers:{'Content-Type':'application/json'}});
    toast(true, `Carimbo aplicado em ${r.data?.aplicados ?? 0} tutorias.`);
    await new Promise(r=>setTimeout(r,150));
    await carregar();
  }catch(e){ console.error(e); toast(false,'Erro ao aplicar em todas.'); }
}
async function aplicarSelecionadas(){
  const ids = selecionados();
  if(!ids.length){ toast(false,'Selecione pelo menos uma tutoria.'); return; }
  const c = campos();
  try{
    await Promise.all(ids.map(id=>axios.post(`/api/gestao/tutorias/${id}/carimbo`, c, {headers:{'Content-Type':'application/json'}})));
    toast(true,'Carimbo aplicado nas selecionadas.');
    await new Promise(r=>setTimeout(r,150));
    await carregar();
  }catch(e){ console.error(e); toast(false,'Erro ao aplicar nas selecionadas.'); }
}
async function aplicarUm(id){
  const c = campos();
  try{
    await axios.post(`/api/gestao/tutorias/${id}/carimbo`, c, {headers:{'Content-Type':'application/json'}});
    toast(true,'Carimbado!');
    await new Promise(r=>setTimeout(r,150));
    await carregar();
  }catch(e){ console.error(e); toast(false,'Erro ao carimbar.'); }
}

async function apagarUm(id){
  if(!confirm('Apagar a tutoria #' + id + '?')) return;
  const senha = pedirSenhaExclusao();
  if(!senha) return;
  try{
    await axios.delete(`/api/gestao/tutorias/${id}`, { data: { senha }, headers:{'Content-Type':'application/json'} });
    toast(true,'Tutoria apagada.');
    await new Promise(r=>setTimeout(r,150));
    await carregar();
  }catch(e){ console.error(e); toast(false,'Erro ao apagar.'); }
}

async function apagarSelecionadas(){
  const ids = selecionados();
  if(!ids.length){ toast(false,'Selecione pelo menos uma tutoria.'); return; }
  const frase = prompt('Para apagar as selecionadas, digite: APAGAR_SELECIONADAS');
  if(frase !== 'APAGAR_SELECIONADAS') return;
  const senha = pedirSenhaExclusao();
  if(!senha) return;
  try{
    const r = await axios.post('/api/gestao/tutorias/excluir', {ids, senha}, {headers:{'Content-Type':'application/json'}});
    toast(true, `Apagadas: ${r.data?.apagadas ?? 0}`);
    await new Promise(r=>setTimeout(r,150));
    await carregar();
  }catch(e){ console.error(e); toast(false,'Erro ao apagar selecionadas.'); }
}

async function apagarTodas(){
  const frase = prompt('ATENÇÃO! Para apagar TODAS as tutorias, digite exatamente: APAGAR_TODAS');
  if(frase !== 'APAGAR_TODAS') return;
  if(!confirm('Tem certeza absoluta? Isso remove TODOS os registros do banco.')) return;
  const senha = pedirSenhaExclusao();
  if(!senha) return;
  try{
    const r = await axios.delete('/api/gestao/tutorias', { data: { confirm:'APAGAR_TODAS', senha }, headers:{'Content-Type':'application/json'} });
    toast(true, `Banco limpo. Apagadas: ${r.data?.apagadas ?? 0}`);
    await new Promise(r=>setTimeout(r,150));
    await carregar();
  }catch(e){ console.error(e); toast(false,'Erro ao apagar todas.'); }
}

</script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script>
async function gerarPdfDoElemento(elementId, filename){
  const el = document.getElementById(elementId);
  if(!el){ alert('Elemento não encontrado para PDF.'); return; }
  const canvas = await html2canvas(el, {scale:2, useCORS:true});
  const imgData = canvas.toDataURL('image/png');
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF('p','mm','a4');
  const pageWidth = 210;
  const imgWidth = pageWidth - 20;
  const imgHeight = canvas.height * imgWidth / canvas.width;
  pdf.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
  pdf.save(filename || 'tutoria.pdf');
}
carregar();
</script>
{% endblock %}
