{% extends 'base.html' %}
{% set title = 'Gestão - Painel' %}
{% block content %}
<div class="d-flex flex-wrap align-items-start justify-content-between gap-2 mb-3">
  <div>
    <h4 class="fw-bold mb-0">Painel da Gestão</h4>
    <div class="soft">Visualize todas as tutorias em <b>Lista</b> ou <b>Impressa</b>. Exclusões exigem senha <span class="mono">1243##</span>.</div>
  </div>
  <div class="d-flex flex-wrap gap-2 align-items-center toolbar-actions">
    <div class="toggle-pill">
      <span class="soft small">Visualização:</span>
      <button type="button" class="btn btn-sm btn-outline-primary" id="gBtnLista">Lista</button>
      <button type="button" class="btn btn-sm btn-outline-primary" id="gBtnImpressa">Impressa</button>
    </div>
    <form method="post" action="{{ url_for('gestao_bloquear') }}">
      <button class="btn btn-outline-secondary">Bloquear</button>
    </form>
  </div>
</div>

<div class="card app-card mb-3">
  <div class="card-body p-3 p-md-4">
    <div class="row g-2 align-items-end">
      <div class="col-12 col-md-5">
        <label class="form-label">Buscar</label>
        <input id="q" class="form-control" placeholder="Aluno, série, tutor, professor...">
      </div>
      <div class="col-12 col-md-3">
        <label class="form-label">Professor</label>
        <select id="prof" class="form-select">
          <option value="">Todos</option>
        </select>
      </div>
      <div class="col-12 col-md-4 d-flex gap-2">
        <button id="btnFiltrar" class="btn btn-primary w-100" type="button">Filtrar</button>
        <button id="btnLimpar" class="btn btn-outline-secondary w-100" type="button">Limpar</button>
      </div>
    </div>

    <div class="d-flex flex-wrap gap-2 mt-3">
      <button id="btnSelAll" class="btn btn-outline-primary btn-sm" type="button">Selecionar todas</button>
      <button id="btnSelNone" class="btn btn-outline-primary btn-sm" type="button">Desmarcar</button>
      <button id="btnDelSel" class="btn btn-outline-danger btn-sm" type="button">Apagar selecionadas</button>
      <button id="btnDelAll" class="btn btn-danger btn-sm" type="button">Apagar TODAS</button>
      <span class="soft small align-self-center" id="info"></span>
    </div>
  </div>
</div>

<!-- CARIMBO DIGITAL (aparece no modo IMPRESSO) -->
<div class="card app-card mb-3">
  <div class="card-body p-3 p-md-4">
    <div class="d-flex flex-wrap justify-content-between align-items-start gap-2 mb-2">
      <div>
        <h6 class="fw-bold mb-0">Carimbo digital</h6>
        <div class="soft small">Define o carimbo que aparece no modo <b>Impressa</b>. Você pode aplicar em todas as tutorias ou apenas nas selecionadas.</div>
      </div>
      <button id="btnDbInfo" class="btn btn-outline-secondary btn-sm" type="button">Diagnóstico DB</button>
    </div>

    <div class="row g-2">
      <div class="col-12 col-md-4">
        <label class="form-label">Responsável</label>
        <input id="car_resp" class="form-control" placeholder="Ex.:Gestor Resposavel">
      </div>
      <div class="col-12 col-md-8">
        <label class="form-label">Instituição</label>
        <input id="car_inst" class="form-control" placeholder="Ex.: Nome da Escola">
      </div>
      <div class="col-12 col-md-6">
        <label class="form-label">Contato</label>
        <input id="car_contato" class="form-control" placeholder="Ex.: Telefone / e-mail / Data  (Opcional) ">
      </div>
      <div class="col-12 col-md-6">
        <label class="form-label">Texto do carimbo</label>
        <input id="car_texto" class="form-control" value="ÊXITO VISTADO">
      </div>
      <div class="col-12">
        <label class="form-label">Observações (opcional)</label>
        <textarea id="car_obs" class="form-control" rows="2" placeholder="Ex.: Validado pela gestão / Data / etc"></textarea>
      </div>
    </div>

    <div class="d-flex flex-wrap gap-2 mt-3">
      <button id="btnCarimboAll" class="btn btn-primary btn-sm" type="button">Aplicar em TODAS</button>
      <button id="btnCarimboSel" class="btn btn-outline-primary btn-sm" type="button">Aplicar nas SELECIONADAS</button>
      <span class="soft small align-self-center">(As mudanças aparecem imediatamente no modo Impressa.)</span>
    </div>
  </div>
</div>

<div id="gViewLista" class="card app-card">
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead>
          <tr>
            <th style="width:42px"><input type="checkbox" id="chkMaster"></th>
            <th>ID</th>
            <th>Data</th>
            <th>Professor</th>
            <th>Aluno</th>
            <th>Série</th>
            <th>Tutor</th>
            <th style="width:200px">Ações</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<div id="gViewImpressa" class="vstack gap-3" style="display:none;"></div>

<!-- Modal Ver (impressa) -->
<div class="modal fade" id="gModalVer" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Tutoria (modo impresso)</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="gModalBody"></div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  const tbody = document.getElementById('tbody');
  const gViewLista = document.getElementById('gViewLista');
  const gViewImpressa = document.getElementById('gViewImpressa');
  const gBtnLista = document.getElementById('gBtnLista');
  const gBtnImpressa = document.getElementById('gBtnImpressa');
  const info = document.getElementById('info');
  const modal = new bootstrap.Modal(document.getElementById('gModalVer'));

  let allItems = [];
  let filtered = [];
  let profMap = new Map();

  // ---- Carimbo (Gestão) ----
  const carResp = document.getElementById('car_resp');
  const carInst = document.getElementById('car_inst');
  const carContato = document.getElementById('car_contato');
  const carTexto = document.getElementById('car_texto');
  const carObs = document.getElementById('car_obs');

  function readCarimbo(){
    return {
      resp: (carResp.value || '').trim(),
      inst: (carInst.value || '').trim(),
      contato: (carContato.value || '').trim(),
      texto: (carTexto.value || 'ÊXITO VISTADO').trim(),
      obs: (carObs.value || '').trim(),
    };
  }

  function fillCarimbo(c){
    if(!c) return;
    carResp.value = c.resp || '';
    carInst.value = c.inst || '';
    carContato.value = c.contato || '';
    carTexto.value = c.texto || 'ÊXITO VISTADO';
    carObs.value = c.obs || '';
  }

  function carimboHtml(c){
    if(!c) c = {};
    const texto = (c.texto || 'ÊXITO VISTADO');
    const inst = (c.inst || '');
    const contato = (c.contato || '');
    const resp = (c.resp || '');
    const obs = (c.obs || '');
    const has = (texto || inst || contato || resp || obs).trim().length > 0;
    if(!has) return `<div class="soft">Sem carimbo.</div>`;
    return `
      <div class="printable-mini p-3 rounded-3 mt-2">
        <div class="d-flex flex-wrap justify-content-between align-items-start gap-2">
          <div>
            <div class="label">Carimbo</div>
            <div class="value fw-bold azul">${texto}</div>
            ${inst ? `<div class="soft small">${inst}</div>` : ``}
            ${contato ? `<div class="soft small">${contato}</div>` : ``}
          </div>
          <div class="text-end">
            <div class="soft small">Responsável</div>
            <div class="value">${resp}</div>
          </div>
        </div>
        ${obs ? `<div class="soft small mt-2">${obs}</div>` : ``}
      </div>
    `;
  }

  function fmtDate(iso){
    try{ return new Date(iso).toLocaleString('pt-BR'); }catch{ return iso; }
  }

  function setMode(mode){
    localStorage.setItem('tutoria_gestao_view_mode', mode);
    if(mode==='impressa'){
      gViewLista.style.display = 'none';
      gViewImpressa.style.display = '';
      gBtnImpressa.classList.add('btn-primary');
      gBtnImpressa.classList.remove('btn-outline-primary');
      gBtnLista.classList.add('btn-outline-primary');
      gBtnLista.classList.remove('btn-primary');
    } else {
      gViewLista.style.display = '';
      gViewImpressa.style.display = 'none';
      gBtnLista.classList.add('btn-primary');
      gBtnLista.classList.remove('btn-outline-primary');
      gBtnImpressa.classList.add('btn-outline-primary');
      gBtnImpressa.classList.remove('btn-primary');
    }
  }
  gBtnLista.addEventListener('click', ()=>setMode('lista'));
  gBtnImpressa.addEventListener('click', ()=>setMode('impressa'));

  async function api(url, options={}){
    const res = await fetch(url, { headers:{'Content-Type':'application/json'}, ...options });
    const data = await res.json().catch(()=> ({}));
    if(!res.ok) throw new Error(data.error || 'Erro');
    return data;
  }

  function getSelectedIds(){
    const s = new Set(Array.from(document.querySelectorAll('input[data-id]:checked')).map(x => parseInt(x.dataset.id, 10)));
    return Array.from(s);
  }

  function render(){
    const pid = (document.getElementById('prof').value || '').trim();
    const nameOf = (t) => (profMap.get(t.professor_id) || ('#'+t.professor_id));

    // ordenação
    const items = [...filtered];
    if(!pid){
      items.sort((a,b)=>{
        const pa = nameOf(a).toLowerCase();
        const pb = nameOf(b).toLowerCase();
        if(pa < pb) return -1;
        if(pa > pb) return 1;
        return (b.criado_em || '').localeCompare(a.criado_em || '');
      });
    } else {
      items.sort((a,b)=> (b.criado_em || '').localeCompare(a.criado_em || ''));
    }

    // contagem por professor (no filtro atual)
    const counts = new Map();
    for(const t of items){
      const p = nameOf(t);
      counts.set(p, (counts.get(p)||0) + 1);
    }

    // ---------- LISTA (tabela) ----------
    tbody.innerHTML = '';
    let lastProf = null;
    for(const t of items){
      const p = nameOf(t);

      // separador por professor quando estiver em "Todos"
      if(!pid && p !== lastProf){
        const trh = document.createElement('tr');
        trh.className = 'group-row';
        const td = document.createElement('td');
        td.colSpan = 8;

        const wrap = document.createElement('div');
        wrap.className = 'd-flex flex-wrap justify-content-between align-items-center gap-2';

        const left = document.createElement('div');
        left.innerHTML = `Professor: <span class="fw-bold"></span>`;
        left.querySelector('span').textContent = p;

        const right = document.createElement('div');
        right.className = 'soft small';
        right.textContent = `${counts.get(p)} tutoria(s)`;

        wrap.appendChild(left);
        wrap.appendChild(right);
        td.appendChild(wrap);
        trh.appendChild(td);
        tbody.appendChild(trh);

        lastProf = p;
      }

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input type="checkbox" data-id="${t.id}"></td>
        <td class="fw-semibold">${t.id}</td>
        <td class="soft">${fmtDate(t.criado_em)}</td>
        <td>${p}</td>
        <td>${t.nome_aluno || ''}</td>
        <td><span class="badge text-bg-secondary">${t.serie || ''}</span></td>
        <td>${t.nome_tutor || ''}</td>
        <td>
          <div class="d-flex flex-wrap gap-2">
            <button class="btn btn-outline-primary btn-sm" data-view="${t.id}">Ver</button>
            <a class="btn btn-outline-success btn-sm" href="/tutorias/${t.id}/pdf" target="_blank">PDF</a>
            <button class="btn btn-outline-danger btn-sm" data-del="${t.id}">Apagar</button>
          </div>
        </td>
      `;
      tbody.appendChild(tr);
    }

    // ---------- IMPRESSA ----------
    gViewImpressa.innerHTML = '';
    lastProf = null;
    for(const t of items){
      const p = nameOf(t);

      // cabeçalho por professor quando estiver em "Todos"
      if(!pid && p !== lastProf){
        const h = document.createElement('div');
        h.className = 'group-title';
        h.innerHTML = `Professor: <span class="fw-bold"></span> <span class="soft small ms-2"></span>`;
        h.querySelector('span.fw-bold').textContent = p;
        h.querySelector('span.soft').textContent = `${counts.get(p)} tutoria(s)`;
        gViewImpressa.appendChild(h);
        lastProf = p;
      }

      const div = document.createElement('div');
      div.className = 'sheet';
      div.setAttribute('data-sheet', t.id);

      const contatos = (t.contatos_extra || []).map(c => {
        const n = (c.nome || '').trim();
        const tel = (c.telefone || '').trim();
        if(!n && !tel) return '';
        return `<tr><td>${n || '-'}</td><td>${tel || '-'}</td></tr>`;
      }).filter(Boolean).join('') || `<tr><td colspan="2" class="soft">Nenhum</td></tr>`;

      const occ = (t.ocorrencias || []).filter(Boolean).map(o => `<span class="badge text-bg-secondary me-1 mb-1">${o}</span>`).join('') || `<span class="soft">Nenhuma marcada.</span>`;
      const assinatura = t.assinatura ? `<img src="${t.assinatura}" alt="assinatura" style="max-width:320px;width:100%;border-radius:12px;" />` : `<div class="soft">Sem assinatura.</div>`;
      const carimbo = carimboHtml(t.carimbo || {});

      div.innerHTML = `
        <div class="d-flex flex-wrap justify-content-between align-items-start gap-2">
          <div>
            <h5 class="fw-bold mb-0">Tutoria</h5>
            <div class="soft small">ID <span class="mono">#${t.id}</span> • ${fmtDate(t.criado_em)} • Professor: ${p}</div>
          </div>
          <div class="d-flex flex-wrap gap-2">
            <label class="btn btn-outline-primary btn-sm mb-0"><input type="checkbox" class="form-check-input me-2" data-id="${t.id}"> Selecionar</label>
            <a class="btn btn-outline-success btn-sm" href="/tutorias/${t.id}/pdf" target="_blank">PDF</a>
            <button class="btn btn-outline-danger btn-sm" data-del="${t.id}">Apagar</button>
          </div>
        </div>

        <hr class="my-3"/>

        <div class="row g-3">
          <div class="col-12 col-md-6"><div class="label">Nome do Tutor</div><div class="value">${t.nome_tutor || ''}</div></div>
          <div class="col-12 col-md-6"><div class="label">Telefone do Aluno</div><div class="value">${t.tel_aluno || ''}</div></div>

          <div class="col-12 col-md-8"><div class="label">Nome do Aluno</div><div class="value">${t.nome_aluno || ''}</div></div>
          <div class="col-12 col-md-4"><div class="label">Série/Turma</div><div class="value">${t.serie || ''}</div></div>

          <div class="col-12">
            <div class="label">Contatos extras</div>
            <div class="table-responsive">
              <table class="table table-sm contacts-table mb-0">
                <thead><tr><th>Nome</th><th>Telefone</th></tr></thead>
                <tbody>${contatos}</tbody>
              </table>
            </div>
          </div>

          <div class="col-12"><div class="label">Projeto de Vida</div><div class="value">${(t.projeto_vida || '')}</div></div>
          <div class="col-12"><div class="label">Descrições</div><div class="value">${(t.descricoes || '')}</div></div>
          <div class="col-12"><div class="label">Ocorrências</div><div>${occ}</div></div>
          <div class="col-12"><div class="label">Assinatura</div>${assinatura}</div>
          <div class="col-12">${carimbo}</div>
        </div>
      `;
      gViewImpressa.appendChild(div);
    }

    // Info
    if(!pid && counts.size > 1){
      const parts = [...counts.entries()].map(([n,c]) => `${n} (${c})`).join(' • ');
      info.textContent = `Mostrando ${items.length} de ${allItems.length} — ${parts}`;
    } else {
      info.textContent = `Mostrando ${items.length} de ${allItems.length}`;
    }
  }

  function applyFilter(){
    const q = (document.getElementById('q').value || '').toLowerCase().trim();
    const pid = (document.getElementById('prof').value || '').trim();
    filtered = allItems.filter(t => {
      if(pid && String(t.professor_id) !== pid) return false;
      if(!q) return true;
      const p = (profMap.get(t.professor_id) || '').toLowerCase();
      const blob = [t.nome_aluno, t.serie, t.nome_tutor, t.tel_aluno, t.projeto_vida, t.descricoes, p].join(' ').toLowerCase();
      return blob.includes(q);
    });
    render();
  }

  async function load(){
    // professores
    const profSel = document.getElementById('prof');
    const profs = await api('/api/gestao/professores');
    profMap = new Map(profs.map(p => [p.id, p.username]));
    profSel.innerHTML = '<option value="">Todos</option>' + profs.map(p => `<option value="${p.id}">${p.username}</option>`).join('');

    // tutorias
    allItems = await api('/api/gestao/tutorias');
    filtered = [...allItems];

    // Preenche o formulário do carimbo com o último valor encontrado (se existir)
    const lastWithCarimbo = [...allItems].find(t => {
      const c = t.carimbo || {};
      return Boolean((c.resp || c.inst || c.contato || c.texto || c.obs) && String(c.resp || c.inst || c.contato || c.texto || c.obs).trim().length > 0);
    });
    if(lastWithCarimbo) fillCarimbo(lastWithCarimbo.carimbo);

    render();
  }

  // Seleção em massa
  document.getElementById('chkMaster').addEventListener('change', (e)=>{
    const checked = e.target.checked;
    document.querySelectorAll('input[data-id]').forEach(c => { c.checked = checked; });
  });

  document.getElementById('btnSelAll').addEventListener('click', ()=>{
    document.querySelectorAll('input[data-id]').forEach(c => { c.checked = true; });
    document.getElementById('chkMaster').checked = true;
  });
  document.getElementById('btnSelNone').addEventListener('click', ()=>{
    document.querySelectorAll('input[data-id]').forEach(c => { c.checked = false; });
    document.getElementById('chkMaster').checked = false;
  });

  // Apagar selecionadas
  document.getElementById('btnDelSel').addEventListener('click', async ()=>{
    const ids = getSelectedIds();
    if(!ids.length) return alert('Selecione pelo menos 1 tutoria.');
    const senha = prompt('Senha para apagar tutorias:');
    if(!senha) return;
    if(!confirm(`Apagar ${ids.length} tutorias selecionadas?`)) return;
    try{
      const r = await api('/api/gestao/tutorias/excluir', {method:'POST', body:JSON.stringify({ids, senha})});
      alert(`Apagadas: ${r.apagadas}`);
      await load();
    }catch(e){ alert(e.message); }
  });

  // Apagar TODAS
  document.getElementById('btnDelAll').addEventListener('click', async ()=>{
    const senha = prompt('Senha para apagar tutorias:');
    if(!senha) return;
    const conf = prompt('Digite APAGAR_TODAS para confirmar:');
    if(conf !== 'APAGAR_TODAS') return;
    if(!confirm('Tem certeza absoluta?')) return;
    try{
      const r = await api('/api/gestao/tutorias', {method:'DELETE', body:JSON.stringify({senha, confirm:'APAGAR_TODAS'})});
      alert(`Apagadas: ${r.apagadas}`);
      await load();
    }catch(e){ alert(e.message); }
  });

  // Carimbo - aplicar em TODAS
  document.getElementById('btnCarimboAll').addEventListener('click', async ()=>{
    try{
      const payload = readCarimbo();
      const r = await api('/api/gestao/carimbo', {method:'POST', body:JSON.stringify(payload)});
      alert(`Carimbo aplicado em ${r.atualizadas} tutorias.`);
      await load();
    }catch(e){ alert(e.message); }
  });

  // Carimbo - aplicar nas SELECIONADAS
  document.getElementById('btnCarimboSel').addEventListener('click', async ()=>{
    const ids = getSelectedIds();
    if(!ids.length) return alert('Selecione pelo menos 1 tutoria.');
    try{
      const payload = readCarimbo();
      let ok = 0;
      for(const id of ids){
        await api(`/api/gestao/tutorias/${id}/carimbo`, {method:'POST', body:JSON.stringify(payload)});
        ok += 1;
      }
      alert(`Carimbo aplicado em ${ok} tutorias selecionadas.`);
      await load();
    }catch(e){ alert(e.message); }
  });

  // Diagnóstico do banco (para conferir se o app e o DBeaver estão no MESMO banco)
  document.getElementById('btnDbInfo').addEventListener('click', async ()=>{
    try{
      const r = await api('/api/gestao/dbinfo');
      alert(
        `DB OK\n\n`+
        `dialect: ${r.dialect}\n`+
        `db_url: ${r.db_url}\n`+
        `tutorias (count): ${r.tutorias_count}\n`+
        `tables: ${(r.tables||[]).join(', ')}`
      );
    }catch(e){ alert(e.message); }
  });

  // Filtrar
  document.getElementById('btnFiltrar').addEventListener('click', applyFilter);

  // aplica filtro automaticamente
  document.getElementById('prof').addEventListener('change', applyFilter);
  document.getElementById('q').addEventListener('input', ()=>{ window.clearTimeout(window._tutoria_qt); window._tutoria_qt=setTimeout(applyFilter, 250); });

  document.getElementById('btnLimpar').addEventListener('click', ()=>{ document.getElementById('q').value=''; document.getElementById('prof').value=''; applyFilter(); });

  // Ações por linha
  document.addEventListener('click', async (e)=>{
    const v = e.target.closest('button[data-view]');
    if(v){
      const id = v.dataset.view;
      const sheet = document.querySelector(`[data-sheet="${id}"]`);
      if(sheet){ document.getElementById('gModalBody').innerHTML = sheet.outerHTML; modal.show(); }
      return;
    }
    const d = e.target.closest('button[data-del]');
    if(d){
      const id = parseInt(d.dataset.del, 10);
      const senha = prompt('Senha para apagar tutorias:');
      if(!senha) return;
      if(!confirm(`Apagar a tutoria #${id}?`)) return;
      try{
        await api(`/api/gestao/tutorias/${id}`, {method:'DELETE', body:JSON.stringify({senha})});
        await load();
      }catch(e){ alert(e.message); }
    }
  });

  setMode(localStorage.getItem('tutoria_gestao_view_mode') || 'lista');
  load();
</script>
{% endblock %}
