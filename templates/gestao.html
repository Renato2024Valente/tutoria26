
{% extends 'base.html' %}
{% block title %}Gestão — Tutorias (geral){% endblock %}
{% block content %}
<div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-2">
  <h2 class="h5 mb-0">Painel da Gestão — visão geral</h2>
  <div class="d-flex gap-2">
    <button class="btn btn-outline-primary btn-sm" onclick="carregar()">Atualizar</button>
    <form method="post" action="/gestao/bloquear" class="d-inline"><button class="btn btn-outline-danger btn-sm">Bloquear Gestão</button></form>
  </div>
</div>

<div class="card mb-3"><div class="card-body">
  <h3 class="h6">Carimbo Digital</h3>
  <div class="row g-2">
    <div class="col-md-3"><input class="form-control" id="c_resp" placeholder="Responsável"></div>
    <div class="col-md-3"><input class="form-control" id="c_inst" placeholder="Instituição"></div>
    <div class="col-md-3"><input class="form-control" id="c_contato" placeholder="Contato (opcional)"></div>
    <div class="col-md-3"><input class="form-control" id="c_texto" value="ÊXITO VISTADO"></div>
    <div class="col-12 d-flex flex-wrap gap-2 mt-2">
      <button class="btn btn-success btn-sm" onclick="aplicarTodas()">Aplicar em todas</button>
      <button class="btn btn-outline-success btn-sm" onclick="aplicarSelecionadas()">Aplicar nas selecionadas</button>
    </div>
    <div id="msg" class="mt-2"></div>
  </div>
</div></div>

<div id="board"></div>
{% endblock %}

{% block scripts %}
<script>
function toast(ok, txt){
  const el = document.getElementById('msg');
  el.innerHTML = `<div class="alert ${ok?'alert-success':'alert-danger'} py-2 mb-0">${txt}</div>`;
  setTimeout(()=>{ el.innerHTML=''; }, 2500);
}
function fmtData(iso){
  const d = new Date(iso);
  return d.toLocaleDateString('pt-BR', {weekday:'long', day:'2-digit', month:'2-digit', year:'numeric'});
}
function diaKey(iso){
  const d = new Date(iso);
  const y = d.getFullYear(), m = (d.getMonth()+1+'').padStart(2,'0'), dd=(''+d.getDate()).padStart(2,'0');
  return `${y}-${m}-${dd}`;
}
function campos(){
  return {
    resp: document.getElementById('c_resp').value.trim(),
    inst: document.getElementById('c_inst').value.trim(),
    contato: document.getElementById('c_contato').value.trim(),
    texto: document.getElementById('c_texto').value.trim() || 'ÊXITO VISTADO',
  };
}
function chk(id){ return `<input class="form-check-input sel" type="checkbox" data-id="${id}">`; }

async function carregar(){
  const [profR, itemsR] = await Promise.all([axios.get('/api/gestao/professores'), axios.get('/api/gestao/tutorias')]);
  const profs = {}; (profR.data||[]).forEach(p=>profs[p.id]=p.username);
  const items = itemsR.data || [];
  const byDay = {};
  items.forEach(t=>{
    const k = diaKey(t.criado_em);
    byDay[k] = byDay[k] || {};
    const prof = profs[t.professor_id] || ('#'+t.professor_id);
    byDay[k][prof] = byDay[k][prof] || [];
    byDay[k][prof].push(t);
  });
  const days = Object.keys(byDay).sort().reverse();
  const board = document.getElementById('board');
  board.innerHTML = days.map(day => {
    const groups = byDay[day];
    const diaLabel = fmtData(day+'T00:00:00Z');
    const profNames = Object.keys(groups).sort((a,b)=>a.localeCompare(b));
    const sections = profNames.map(name=>{
      const arr = groups[name].sort((a,b)=> new Date(b.criado_em) - new Date(a.criado_em));
      const cards = arr.map(t=>`
        <div class="col-12 col-md-6">
          <div class="card shadow-sm mb-2">
            <div class="card-body p-3">
              <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
                <div>
                  <div class="fw-bold">${t.nome_aluno} <span class="badge text-bg-primary">${t.serie}</span></div>
                  <div class="small text-muted">${new Date(t.criado_em).toLocaleString('pt-BR')}</div>
                  <div class="small text-secondary">Professor: <b>${name}</b></div>
                </div>
                <div class="d-flex align-items-center gap-2">
                  ${chk(t.id)}
                  <button class="btn btn-sm btn-outline-primary" onclick="aplicarUm(${t.id})">Carimbar só esta</button>
                </div>
              </div>
              <div class="small mt-2">
                <div><b>Projeto de Vida:</b> ${t.projeto_vida||'-'}</div>
                <div><b>Descrições:</b> ${t.descricoes||'-'}</div>
                <div><b>Ocorrências:</b> ${(t.ocorrencias||[]).join(', ')||'-'}</div>
              </div>
              <div class="p-2 mt-2 rounded-2 printable-mini">
                <div class="fw-bold azul">${(t.carimbo && t.carimbo.texto)||'—'}</div>
                <div class="small"><b>Responsável:</b> ${(t.carimbo && t.carimbo.resp)||'—'}</div>
                <div class="small"><b>Instituição:</b> ${(t.carimbo && t.carimbo.inst)||'—'}</div>
                <div class="small"><b>Contato:</b> ${(t.carimbo && t.carimbo.contato)||'—'}</div>
              </div>
            </div>
          </div>
        </div>
      `).join('');
      return `
        <div class="card mb-3">
          <div class="card-header bg-white"><b>${name}</b></div>
          <div class="card-body">
            <div class="row">${cards}</div>
          </div>
        </div>
      `;
    }).join('');
    return `<div class="mb-4"><h3 class="h6 text-uppercase text-secondary mb-2">${diaLabel}</h3>${sections || '<div class="alert alert-info">Sem registros.</div>'}</div>`;
  }).join('');
}

function selecionados(){ return Array.from(document.querySelectorAll('.sel:checked')).map(x=>Number(x.getAttribute('data-id'))); }
async function aplicarTodas(){ const c=campos(); try{ await axios.post('/api/gestao/carimbo', c); toast(true,'Carimbo aplicado em todas.'); carregar(); }catch(e){ console.error(e); toast(false,'Erro ao aplicar em todas.'); } }
async function aplicarSelecionadas(){
  const ids = selecionados(); if(!ids.length){ toast(false,'Selecione pelo menos uma tutoria.'); return; }
  const c=campos(); try{ await Promise.all(ids.map(id=>axios.post(`/api/gestao/tutorias/${id}/carimbo`, c))); toast(true,'Carimbo aplicado nas selecionadas.'); carregar(); }catch(e){ console.error(e); toast(false,'Erro.'); }
}
async function aplicarUm(id){ const c=campos(); try{ await axios.post(`/api/gestao/tutorias/${id}/carimbo`, c); toast(true,'Carimbado!'); carregar(); }catch(e){ console.error(e); toast(false,'Erro.'); } }

carregar();
</script>
{% endblock %}
